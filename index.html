<!DOCTYPE html>
<html>
    <head>
        <title>VATBoard</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
        <link rel="stylesheet" href="resources/vatboard.css">
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43943268-2"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag('js', new Date());

            gtag('config', 'UA-43943268-2');
        </script>
    </head>
    <body>
        <div style="margin-top:15px;" class="container-fluid">
            <div class="row">
                <div class="col-3">
                    <div class="container-fluid">
                        <img id ="dep-icon" src="resources/dep-icon.png" width="70" alt="dep" style="margin-right:30px;">
                        <img id ="arr-icon" src="resources/arr-icon.png" width="70" alt="arr">                        
                    </div>
                </div>
                <div class="col-2">
                    <div class="container-fluid">
                        <p>Arrivals:<span style="margin-left:5px;" id="arrcount"></span> </p><p>Departures:<span id="depcount" style="margin-left:5px;"></span></p>    
                    </div>
                </div>
                <div class="col-3 text-center">
                    <div class="container-fluid text-center" style="margin:auto;">
                        <span id="vattitle">VATBOARD</span>
                    </div>
                </div>
                <div class="col-4">
                    <div class="container-fluid text-center" style="margin:auto;">
                        <span id="txttoggle">Style:</span>    
                        <input id="toggleMode" 
                               type="checkbox" 
                               checked data-style="ios" 
                               data-toggle="toggle" 
                               data-on="Scroll" 
                               data-off="Fade" 
                               data-onstyle="warning" 
                               data-offstyle="info" 
                               data-size="xs">    
                        <div id="MyClockDisplay" class="clock text-center align-middle" onload="showTime()"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <table id="table" 
                   class="table-sm table-dark table-striped table-borderless"
                   data-show-pagination-switch="false"
                   data-pagination="false"
                   data-height ="400"
                   data-virtual-scroll ="true"
                   data-only-info-pagination="true"
                   data-pagination-loop="false">
                <thead class="thead-light">
                    <tr>
                        <th data-field="callsign" data-formatter="logoFormatter" class="vat-center">Callsign</th>
                        <th data-field="planned_depairport" data-formatter = "airportsFormatter" class="vat-center">Route</th>
                        <th data-field="planned_aircraft" class="vat-center">Aircraft</th>
                        <th data-field="altitude" class="vat-right">Altitude</th>
                        <th data-field="groundspeed" class="vat-right">GS</th>
                        <th data-field="dest_distance" class="vat-right">Distance</th>
                        <th data-field="ETA" class="vat-center">ETA</th>
                    </tr>
                </thead>
            </table>
            <div class="row-fluid text-center">
                <span id="appinfo" class="text-center"></span>     
            </div>

        </div>
        <script src="resources/jquery-3.5.0.min.js"></script>
        <script src="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
        <script>
                            function logoFormatter(value, row, index) {
                                var airline = value.trim().substring(0, 3);
                                return '<img alt="" width=24px src="resources/logos/' + airline + '.png"><span style="margin-left:10px;">' + value + '</span>';
                            }
                            function airportsFormatter(value, row, index) {
                                return [
                                    value,
                                    '<span id="arrow-route-container"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16"><path class="arrow-route" d="M7.5 11.5L9 13l5-5-5-5-1.5 1.5L10.179 7H2v2h8.179L7.5 11.5z"/></svg></span>',
                                    row.planned_destairport
                                ].join('');
                            }
                            $(function () {
                                var vatsimdata = [];
                                var currentMode = '';
                                var arrivals = 0;
                                var departures = 0;
                                var rateArrivals = 0;
                                var rateDepartures = 0;
                                var needAnimation;
                                var timerPrimary;
                                var timerFadeout;
                                var $table = $('#table');
                                var icao_url = getUrlParam('icao', 'LGAV').toUpperCase();
                                var mode = true;
                                //
                                //MAIN
                                //
                                getVersion();
                                getData();
                                timerPrimary = setInterval(getData, 70000);
                                showTime();
                                //        
                                //Functions/Methods
                                //
                                function getData() {
                                    $.getJSON('getpilots.php', {icao: escape(icao_url)}, function (d) {
                                        vatsimdata = d;
                                        postgetData(d);
                                    });
                                }
                                function getVersion() {
                                    $.getJSON('getversion.php', function (ver) {
                                        var fullInfo = '\251 2020 Elias Stassinos, ' + ver;
                                        $('#appinfo').text(fullInfo);
                                    });
                                }
                                function postgetData(d) {
                                    $('.fixed-table-body').stop(true, true); // Stop animation
                                    $table.bootstrapTable({
                                        data: d,
                                        theadClasses: 'thead-dark'
                                    });
                                    $table.bootstrapTable('load', d);
                                    prepareCounters(d);
                                    updateCounters(d);
                                    $('#vattitle').text("VATBoard - Arrivals / Departures for " + icao_url);
                                    //Do the loop until reload
                                    determineFilter();
                                    determineAnimation();
                                    determineMode();
                                    setTimeout(function () {
                                        determineFilter();
                                        determineMode();
                                    }, 30000);
                                }
                                function getUrlParam(parameter, defaultvalue) {
                                    var urlparameter = defaultvalue;
                                    if (window.location.href.indexOf(parameter) > -1) {
                                        urlparameter = getUrlVars()[parameter];
                                    }
                                    return urlparameter;
                                }
                                function getUrlVars() {
                                    var vars = {};
                                    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
                                        vars[key] = value;
                                    });
                                    return vars;
                                }
                                $('#toggleMode').change(function () {
                                    if ($('#toggleMode').prop('checked') === true) {
                                        stopfadeoutFirst();
                                        mode = true;
                                        determineMode();
                                    } else {
                                        stopanimateScroll();
                                        mode = false;
                                        determineMode();
                                    }
                                    $('.fixed-table-body').scrollTop(0);
                                });
                                function determineFilter() {
                                    if (currentMode === 'arr') {
                                        filterDepartures();
                                    } else {
                                        filterArrivals();
                                    }
                                }
                                function determineMode() {
                                    if (needAnimation === true) {
                                        if (mode === true) {
                                            animateScroll();
                                        } else {
                                            fadeoutFirst();
                                        }
                                    }
                                }
                                function filterArrivals() {
                                    currentMode = 'arr';
                                    $('#arr-icon').attr('src', 'resources/arr-icon-enable.png');
                                    $('#dep-icon').attr('src', 'resources/dep-icon.png');
                                    $('#table').bootstrapTable('filterBy', {
                                        planned_destairport: icao_url
                                    });
                                }
                                function filterDepartures() {
                                    currentMode = 'dep';
                                    $('#arr-icon').attr('src', 'resources/arr-icon.png');
                                    $('#dep-icon').attr('src', 'resources/dep-icon-enable.png');
                                    $('#table').bootstrapTable('filterBy', {
                                        planned_depairport: icao_url
                                    });
                                }
                                function updateCounters(d) {
                                    $('#arrcount').text(arrivals);
                                    $('#depcount').text(departures);
                                }
                                function prepareCounters(d) {
                                    arrivals = d.filter(v => v.planned_destairport === icao_url).length;
                                    departures = d.filter(v => v.planned_depairport === icao_url).length;
                                    rateArrivals = arrivals * 1000;
                                    rateDepartures = departures * 1000;
                                }
                                function determineAnimation() {
                                    if ((currentMode === "arr" && arrivals > 10) || (currentMode === "dep" && departures > 10)) {
                                        needAnimation = true;
                                    } else {
                                        needAnimation = false;
                                    }
                                }
                                function determineRate() {
                                    return (currentMode === 'arr') ? rateArrivals : rateDepartures;
                                }
                                function animateScroll() {
                                    $('.fixed-table-body').animate({scrollTop: $('.fixed-table-body').prop("scrollHeight")}, determineRate(), 'linear');
                                    $('.fixed-table-body').animate({scrollTop: 0}, determineRate(), 'linear');
                                }
                                function stopanimateScroll() {
                                    $('.fixed-table-body').stop(true, true);
                                }
                                function fadeoutFirst() {
                                    timerFadeout = setInterval(function () {
                                        $('#table tbody tr:first').fadeOut(1000, function () {
                                            $(this).remove();
                                            if ($('#table tbody tr').length <= 10) {
                                                stopfadeoutFirst();
                                            }
                                        });
                                    }, 2500);
                                }
                                function stopfadeoutFirst() {
                                    clearTimeout(timerFadeout);
                                }
                                function showTime() {
                                    var date = new Date();
                                    var offsetHours = date.getTimezoneOffset() / 60;
                                    var h = date.getHours() + (offsetHours); // 0 - 23
                                    var m = date.getMinutes(); // 0 - 59
                                    var s = date.getSeconds(); // 0 - 59
//                                        var session = "AM";
//
//                                    if (h == 0) {
//                                        h = 12;
//                                    }
//
//                                    if (h > 12) {
//                                        h = h - 12;
//                                        session = "PM";
//                                    }
//
                                    h = (h < 10) ? "0" + h : h;
                                    m = (m < 10) ? "0" + m : m;
                                    s = (s < 10) ? "0" + s : s;

                                    var time = h + ":" + m + ":" + s + " ";
                                    document.getElementById("MyClockDisplay").innerText = time;
                                    document.getElementById("MyClockDisplay").textContent = time;

                                    setTimeout(showTime, 1000);

                                }
                                $("#arr-icon").click(function () {
                                    filterArrivals();
                                });
                                $("#dep-icon").click(function () {
                                    filterDepartures();
                                });
                            });
        </script>
    </body>
</html>
