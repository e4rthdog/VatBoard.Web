<!DOCTYPE html>
<html>
    <head>
        <title>VATBoard</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.css">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" crossorigin="anonymous">
        <link rel="stylesheet" href="resources/vatboard.css">
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-43943268-2"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag('js', new Date());

            gtag('config', 'UA-43943268-2');
        </script>
    </head>
    <body>
        <div>
            <table id="tableHeader" width=100% style="margin-bottom:20px;">
                <tr>
                    <td width="25%" style="text-align:left;padding-left: 40px;padding-top:10px;">
                        <img id ="dep-icon" src="resources/dep-icon.png" width="70" alt="dep" style="margin-right:30px;">
                        <img id ="arr-icon" src="resources/arr-icon.png" width="70" alt="arr">
                    </td>
                    <td width="15%" style="text-align:left;padding-left: 40px;padding-top:10px;">
                        <p>Arrivals:<span style="margin-left:5px;" id="arrcount"></span> </p><p>Departures:<span id="depcount" style="margin-left:5px;"></span></p>
                    </td>
                    <td width="35%" id ="vattitle">
                        VATBoard
                    </td>
                    <td id="appinfo" width="25%">
                    </td>
                </tr>
            </table>
            <table id="table" 
                   class="table-sm table-dark table-striped table-borderless"
                   data-show-pagination-switch="false"
                   data-pagination="false"
                   data-height ="400"
                   data-virtual-scroll ="true"
                   data-only-info-pagination="true"
                   data-pagination-loop="false">
                <thead class="thead-light">
                    <tr>
                        <th data-field="callsign" data-formatter="logoFormatter" class="vat-center">Callsign</th>
                        <th data-field="planned_depairport" data-formatter = "airportsFormatter" class="vat-center">Route</th>
                        <!--                    <th data-field="planned_depairport" class="vat-center">Origin</th>
                                            <th data-field="planned_destairport" class="vat-center">Destination</th>-->
                        <th data-field="planned_aircraft" class="vat-center">Aircraft</th>
                        <th data-field="altitude" class="vat-right">Altitude</th>
                        <th data-field="groundspeed" class="vat-right">GS</th>
                        <th data-field="dest_distance" class="vat-right">Distance</th>
                        <th data-field="ETA" class="vat-center">ETA</th>
                    </tr>
                </thead>
            </table>
        </div>
        <script src="resources/jquery-3.5.0.min.js"></script>
        <script src="https://unpkg.com/bootstrap-table@1.16.0/dist/bootstrap-table.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script>
            function logoFormatter(value, row, index) {
                var airline = value.trim().substring(0, 3);
                return '<img alt="" width=24px src="resources/logos/' + airline + '.png"><span style="margin-left:10px;">' + value + '</span>';
            }
            function airportsFormatter(value, row, index) {
                return [
                    value,
                    '<span id="arrow-route-container"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 16 16"><path class="arrow-route" d="M7.5 11.5L9 13l5-5-5-5-1.5 1.5L10.179 7H2v2h8.179L7.5 11.5z"/></svg></span>',
                    row.planned_destairport
                ].join('');
            }
            $(function () {
                var vatsimdata = [];
                var currentMode = '';
                var arrivals = 0;
                var departures = 0;
                var rateArrivals = 0;
                var rateDepartures = 0;
                var $table = $('#table');
                var icao_url = getUrlParam('icao', 'LGAV').toUpperCase();
                var mode_url = getUrlParam('mode', 'SCROLL').toUpperCase();
                //
                //MAIN
                //
                getVersion();
                getData();
                var primaryTimer = setInterval(getData, 70000);
                //        
                //Functions/Methods
                //
                function getData() {
                    $.getJSON('getpilots.php', {icao: escape(icao_url)}, function (d) {
                        vatsimdata = d;
                        postgetData(d);
                    });
                }
                function getVersion() {
                    $.getJSON('getversion.php', function (ver) {
                        $('#appinfo').text(ver);
                    });
                }
                function postgetData(d) {
                    $('.fixed-table-body').stop(true, true); // Stop animation
                    $table.bootstrapTable({
                        data: d,
                        theadClasses: 'thead-dark'
                    });
                    $table.bootstrapTable('load', d);
                    prepareCounters(d);
                    updateCounters(d);
                    $('#vattitle').text("VATBoard - Arrivals / Departures for " + icao_url);
                    //Do the loop until reload
                    determineFilter();
                    animateScroll();
                    setTimeout(function () {
                        determineFilter();
                    }, 30000);
                }
                function getUrlParam(parameter, defaultvalue) {
                    var urlparameter = defaultvalue;
                    if (window.location.href.indexOf(parameter) > -1) {
                        urlparameter = getUrlVars()[parameter];
                    }
                    return urlparameter;
                }
                function getUrlVars() {
                    var vars = {};
                    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
                        vars[key] = value;
                    });
                    return vars;
                }
                function determineFilter() {
                    if (currentMode === 'arr') {
                        filterDepartures();
                    } else {
                        filterArrivals();
                    }
                }
                function filterArrivals() {
                    currentMode = 'arr';
                    $('#arr-icon').attr('src', 'resources/arr-icon-enable.png');
                    $('#dep-icon').attr('src', 'resources/dep-icon.png');
                    $('#table').bootstrapTable('filterBy', {
                        planned_destairport: icao_url
                    });
                }
                function filterDepartures() {
                    currentMode = 'dep';
                    $('#arr-icon').attr('src', 'resources/arr-icon.png');
                    $('#dep-icon').attr('src', 'resources/dep-icon-enable.png');
                    $('#table').bootstrapTable('filterBy', {
                        planned_depairport: icao_url
                    });
                }
                function updateCounters(d) {
                    $('#arrcount').text(arrivals);
                    $('#depcount').text(departures);
                }
                function prepareCounters(d) {
                    arrivals = d.filter(v => v.planned_destairport === icao_url).length;
                    departures = d.filter(v => v.planned_depairport === icao_url).length;
                    rateArrivals = arrivals * 1000;
                    rateDepartures = departures * 1000;
                }
                function animateScroll() {
                    var rate = (currentMode === 'arr') ? rateArrivals : rateDepartures;
                    if ((currentMode === "arr" && arrivals > 10) || (currentMode === "dep" && departures > 10)) {
                        $('.fixed-table-body').animate({scrollTop: $('.fixed-table-body').prop("scrollHeight")}, rate, 'linear');
                        $('.fixed-table-body').animate({scrollTop: 0}, rate, 'linear');
                    }
                }
                $("#arr-icon").click(function () {
                    filterArrivals();
                });
                $("#dep-icon").click(function () {
                    filterDepartures();
                });
                $('#vattitle').click(function () {
                    if ($(".fixed-table-body").is(':animated')) {
                        $('.fixed-table-body').stop(true, true);
                    } else {
                        animateScroll();
                    }
                });
            });
        </script>
    </body>
</html>
